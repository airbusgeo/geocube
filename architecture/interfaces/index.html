<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/airbusgeo/geocube/architecture/interfaces/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Interfaces - Geocube Server</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Interfaces";
        var mkdocs_page_input_path = "architecture/interfaces.md";
        var mkdocs_page_url = "/airbusgeo/geocube/architecture/interfaces/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Geocube Server
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../quickstart/">Getting started</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Architecture</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../solution/">Ecosystem</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../services/">Geocube services</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Interfaces</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#storage">Storage</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface">Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#currently-supported-storages">Currently supported storages</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#messaging">Messaging</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_1">Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pgqueue-implementation">Pgqueue implementation</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#pubsub-implementation">Pubsub implementation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#database">Database</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#interface_2">Interface</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#postgresql-implementation">PostgreSQL Implementation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#autoscaler">Autoscaler</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#grpc">GRPC</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mucog/">MuCOG</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/grpc/">GRPC documentation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Installation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/prerequisite/">Prerequisite</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/local-install/">Local environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/docker-install/">Docker</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/k8s-install/">Deploying with Kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/others/">Customize environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../installation/upgrade/">Upgrade</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">User guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/tutorials/">Tutorials</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/entities/">Entities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/indexation/">Indexation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/access/">Access</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/consolidation/">Consolidation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/deletion/">Deletion</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user-guide/scaleup/">Scaling-up</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/help/">Getting help</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/CONTRIBUTING/">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/license/">License</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../about/release-notes/">Release Notes</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Geocube Server</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Architecture</li>
      <li class="breadcrumb-item active">Interfaces</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="interfaces">Interfaces</h2>
<p>Geocube is designed to be customizable and deployable in other environments. Several interfaces are declared and can be implemented to use external tools or services.</p>
<p><img alt="Architecture" src="../../images/GeocubeArchitecture.png" /></p>
<p>All the interfaces are declared in the <code>interface</code> folder of the repository. After implementing an interface, it may be necessary to customize the <code>cmd/[...]/main.go</code> files to use the new interface.</p>
<p>If you implement a new interface, it will be very welcome to submit a <a href="https://github.com/airbusgeo/geocube/blob/main/CONTRIBUTING.md">contribution</a>.</p>
<h3 id="storage">Storage</h3>
<h4 id="interface">Interface</h4>
<p>The interface storage is used to read and write the images that are indexed in the Geocube. It must be accessible in reading by range-request and should be accessible in writing to support the consolidation (optimisation of the data).
The interface is available in <code>interface/storage</code> package.</p>
<p>To add a storage strategy, the following methods are to be implemented:</p>
<pre><code class="language-golang">// Download file content as a slice of byte
Download(ctx context.Context, uri string, options ...Option) ([]byte, error)
// DownloadTo a local file
DownloadTo(ctx context.Context, source string, destination string, options ...Option) error
// Upload file content into remote file
Upload(ctx context.Context, uri string, data []byte, options ...Option) error
// UploadFile into remote file
UploadFile(ctx context.Context, uri string, data io.ReadCloser, options ...Option) error
// Delete file
Delete(ctx context.Context, uri string, options ...Option) error
// Exist checks if file exist
Exist(ctx context.Context, uri string) (bool, error)
// GetAttrs returns file attribute
GetAttrs(ctx context.Context, uri string) (Attrs, error)
</code></pre>
<p>The storage is infered from the prefix of the uri (protocol). The user can add an additionnal storage by implementing the interface and adding it in the <code>interface/storage/uri/</code> package.</p>
<h4 id="currently-supported-storages">Currently supported storages</h4>
<p>Currently, the geocube code supports three storage systems: AWS-S3, GCS and filesystem.</p>
<h3 id="messaging">Messaging</h3>
<h4 id="interface_1">Interface</h4>
<p>The messaging interface is available here : <code>interface/messaging/</code>.
It is used to communicate between the ApiServer and the Consolidater, and it can be used as a metric by the Autoscaler to autoscale the ressources for the consolidater. It's a parameter of the constructor of the Service Class and it is configured in the following files: <code>cmd/apiserver/main.go</code> and <code>cmd/consolidater/main.go</code>.</p>
<h4 id="pgqueue-implementation">Pgqueue implementation</h4>
<p>A messaging interface based on postgres is implemented using the <a href="https://github.com/btubbs/pgq">btubbs/pgq</a> library: <code>interface/messaging/pgqueue</code>. This implementation has autoscaling capabilities.</p>
<h4 id="pubsub-implementation">Pubsub implementation</h4>
<p>Geocube supports PubSub (Google Cloud Platform) messaging broker : <code>interface/messaging/pubsub</code>.</p>
<p>Topics and subscriptions are to be created.</p>
<p>Topics:
- events
- events-failed
- consolidations
- consolidations-failed
- consolidations-worker (only if autoscaler is used)</p>
<p>Subscriptions:
- events
- consolidations
- consolidations-worker (only if autoscaler is used)</p>
<p>These actions could be performed manually or with terraform.
For more information, see: https://cloud.google.com/pubsub/docs/overview.
You must have the Pub/Sub Admin role on your service account.</p>
<p>NB: Topics &amp; Subscriptions must be created before running services.</p>
<p>A Pub/Sub emulator is available to use PubSub in a local system (with limited capacities).</p>
<p>Please follow the <a href="https://cloud.google.com/pubsub/docs/emulator">documentation</a> to install and start the emulator.</p>
<h3 id="database">Database</h3>
<h4 id="interface_2">Interface</h4>
<p>The database interface is available here : <code>interface/database/db.go</code>.
It is used by the ApiServer as a parameter of the constructor of the service and it is configured in the following file: <code>cmd/apiserver/main.go</code>.</p>
<h4 id="postgresql-implementation">PostgreSQL Implementation</h4>
<p>Geocube currently supports a Postgresql database with the PostGIS extension (<code>interface/database/pg/</code>).
Create a database and run the installation SQL script in order to create all tables, schemas and roles.
This script is available in Geocube code source in <code>interface/database/pg/create.sql</code></p>
<pre><code class="language-bash">$ psql -h &lt;database_host&gt; -d &lt;database_name&gt; -f interface/database/pg/create.sql
</code></pre>
<p>For ugrade, see <a href="#postgresql-database">Update PostgreSQL database</a></p>
<h3 id="autoscaler">Autoscaler</h3>
<p>The autoscaler handles the scale-up or down of the consolidator service.
It’s an external service and does not have an interface. The current implementation, using Kubernetes, is available here : <code>interface/autoscaler/</code> and it is used in the Autoscaler service : <code>cmd/autoscaler/main.go</code></p>
<h3 id="grpc">GRPC</h3>
<p>Clients connect to the Geocube with a GRPC interface. This interface is automatically generated from the protobuf files in <code>api/v1/pb</code>.</p>
<p>From the Geocube side, protofiles are generated in the <code>internal/pb</code> folder. A GRPC server is then implemented in <code>internal/grpc</code> to interface the GRPC layer to the Geocube server.</p>
<p>From the client side, protofiles must be generated using the same files. It automatically creates a GRPC interface to connect to the Geocube.
See <a href="https://github.com/airbusgeo/geocube-client-python">Client Python</a> or <a href="https://github.com/airbusgeo/geocube-client-go">Client Go</a> for example.</p>
<p>Install <code>protoc</code></p>
<pre><code class="language-shell">go get -u github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway
go get -u github.com/golang/protobuf/protoc-gen-go
</code></pre>
<p>Generate output from protofiles :</p>
<pre><code class="language-bash">go generate generate.go
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../services/" class="btn btn-neutral float-left" title="Geocube services"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../mucog/" class="btn btn-neutral float-right" title="MuCOG">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../services/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../mucog/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
